<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/website/layout/layout}">

<meta http-equiv="content-type" content="text/html;charset=UTF-8"/><!-- /Added by HTTrack -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="stylesheet" href="https://unicons.iconscout.com/release/v4.0.0/css/line.css">

    <style>
        .ultag {
            display: flex;
        }

        ul .litag {
            list-style: none;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        ul li .icon {
            font-size: 35px;
            margin: -8px 90px;
            color: #fff;
            position: relative;
            top: 10px;
            left: 75px;
        }

        ul li .text {
            font-size: 20px;
            /* font-weight: 600; */
            text-align: center;
            /* color: #ff4732; */
        }


        ul li .progress {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: rgb(122, 125, 122);
            margin-top: 24px;
            margin-left: 156px;
            display: grid;
            place-items: center;
            color: #fff;
            position: relative;
            cursor: pointer;
            overflow: visible;

        }


        .progress::after {
            content: " ";
            position: absolute;
            width: 184px;
            height: 5px;
            background-color: rgb(122, 125, 122);
            right: 32px;
        }

        .one::after {
            width: 0;
            height: 0;
        }

        ul li .progress .uil {
            display: none;
        }

        ul li .progress p {
            font-size: 13px;
        }

        /* Active Css  */

        ul li .active {
            background-color: #b19361;
            display: grid;
            place-items: center;
        }

        li .active::after {
            background-color: #b19361;
        }

        ul li .active p {
            display: none;
        }

        ul li .active .uil {
            font-size: 20px;
            display: flex;
        }
    </style>

</head>

<body layout:fragment="content2">
<div id="mobile-menu-offcanvas" class="offcanvas offcanvas-rightside offcanvas-mobile-menu-section">
    <!-- Start Offcanvas Header -->
    <div class="offcanvas-header text-right">
        <button class="offcanvas-close"><i class="ion-android-close"></i></button>
    </div> <!-- End Offcanvas Header -->
    <!-- Start Offcanvas Mobile Menu Wrapper -->
    <div class="offcanvas-mobile-menu-wrapper">
        <!-- Start Mobile Menu  -->
        <div class="mobile-menu-bottom">
            <!-- Start Mobile Menu Nav -->
            <div class="offcanvas-menu">
                <ul>
                    <li>
                        <a class="main-menu-link" th:href="@{/sophia-store/home}">Trang chủ </a>
                    </li>
                    <li class="has-megaitem">
                        <a th:href="@{/sophia-store/product}">Sản phẩm </a>
                    </li>
                    <li>
                        <a th:href="@{/sophia-store/chung-toi}">Về chúng tôi</a>
                    </li>
                    <li>
                        <a th:href="@{/sophia-store/lien-he}">Liên hệ</a>
                    </li>
                    <li>
                        <a th:href="@{/sophia-store/FAQS}">FAQS</a>
                    </li>
                </ul>
            </div>
        </div>


    </div>
</div>

<div class="breadcrumb-section breadcrumb-bg-color--golden">
    <div class="breadcrumb-wrapper">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <h3 class="breadcrumb-title">Chi tiết đơn hàng</h3>
                </div>
            </div>
        </div>
    </div>
</div> <!-- ...:::: End Breadcrumb Section:::... -->
<div class="cart-section">
    <div class="container mb-5  aos-init aos-animate" data-aos="fade-up" data-aos-delay="0"
         style="background-color: #fff; height: 250px; max-width: 1197px;">
        <div class="main">
            <ul class="ultag mt-3">
                <li class="litag">
                    <i id="icon1" class="icon uil uil-circle"></i>
                    <div class="progress one">
                        <i class="uil uil-check"></i>
                    </div>
                    <p style="position: relative; top: 10px; left: 73px;" class="text" id="text1"></p>
                </li>
                <li class="litag">
                    <i id="icon2" class="icon uil uil-circle"></i>
                    <div class="progress two">
                        <i class="uil uil-check"></i>
                    </div>
                    <p style="position: relative; top: 10px; left: 73px;" class="text" id="text2"></p>
                </li>
                <li class="litag">
                    <i id="icon3" class="icon uil uil-circle"></i>
                    <div class="progress three">
                        <i class="uil uil-check"></i>
                    </div>
                    <p style="position: relative; top: 10px; left: 73px;" class="text" id="text3"></p>
                </li>
                <li class="litag">
                    <i id="icon4" class="icon uil uil-circle"></i>
                    <div class="progress four">
                        <i class="uil uil-check"></i>
                    </div>
                    <p style="position: relative; top: 10px; left: 73px;" class="text" id="text4"></p>
                </li>
                <li class="litag">
                    <i id="icon5" class="icon uil uil-circle"></i>
                    <div class="progress five">
                        <i class="uil uil-check"></i>
                    </div>
                    <p class="text" style="position: relative; top: 10px; left: 73px;" id="text5"></p>
                </li>
            </ul>
        </div>
    </div>

    <div class="cart-table-wrapper" data-aos="fade-up" data-aos-delay="0">
        <div class="container" style="max-width: 1140px;">
            <div class="ttdh mb-5 mt-4">

                <div class="row mb-2">
                    <h4 class="mt-3  text-center">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Thông tin đơn hàng</h4>
                    <hr style="width: 1000px;position: relative;left: 95px;color: black;height: 1px;background-color: black;">
                </div>


                <div class="row mt-4">
                    <div class="col-1"></div>
                    <div class="col-6"
                         th:text="${'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Người nhận: &nbsp;&nbsp;&nbsp;'+hoaDon.tenKhachHang}"></div>
                    <div class="col-5">
                        <span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Điện thoại: &nbsp;&nbsp;&nbsp;&nbsp;</span>
                        <span th:text="${hoaDon.soDienThoai}"></span>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-1"></div>
                    <div class="col-6"><span
                            th:text="${'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Địa chỉ: &nbsp;&nbsp;&nbsp;'+hoaDon.diaChi}"></span>
                    </div>
                    <div class="col-5">
                        <span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Trạng thái: &ensp;&ensp;&ensp;&ensp;</span>
                        <span th:if="${hoaDon.trangThai == 1}">Thành công</span>
                        <span th:if="${hoaDon.trangThai == 3}">Chờ xác nhận</span>
                        <span th:if="${hoaDon.trangThai == 4}">Chờ giao</span>
                        <span th:if="${hoaDon.trangThai == 5}">Đang giao</span>
                        <span th:if="${hoaDon.trangThai == 6}">Hủy</span>
                        <span th:if="${hoaDon.trangThai == 7}">Giao thất bại</span>
                        <span th:if="${hoaDon.trangThai == 6}">Chờ thanh toán</span>
                    </div>


                </div>

                <div class="row mt-4">
                    <div class="col-1"></div>
                    <div class="col-6">
                        <div th:switch="${httt.trangThai}">
                            <span th:case="2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Loại giao dịch: &nbsp;&nbsp;&nbsp;Chuyển khoản</span>
                            <span th:case="3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Loại giao dịch: &nbsp;&nbsp;&nbsp;Trả sau</span>
                        </div>
                    </div>
                    <div class="col-5" th:if="${hoaDon.trangThai == 6 || hoaDon.trangThai == 7}">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Lí do:&nbsp;&nbsp;&nbsp;
                        <span th:text="${hoaDon.ghiChu}"></span>
                    </div>

                </div>

                <div class="row mt-4">
                    <div class="col-12">
                        <div class="table_desc mt-5">
                            <div class="table_page table-responsive">
                                <table>
                                    <!-- Start Cart Table Head -->
                                    <thead>
                                    <tr>
                                        <th class="product_remove">STT</th>
                                        <th class="product_thumb">Ảnh</th>
                                        <th class="product_name">Tên</th>
                                        <th class="product-price">Size</th>
                                        <th class="product_quantity">Số lượng</th>
                                        <th class="product_total">Thành tiền</th>
                                    </tr>
                                    </thead> <!-- End Cart Table Head -->
                                    <tbody>
                                    <!-- Start Cart Single Item-->
                                    <tr th:each="hdct,start : ${listhdct}">
                                        <td th:text="${start.index+1}"></td>
                                        <td><img th:src="${avtctgMap[hdct.chiTietGiay.id]}" alt="" width="100"
                                                 height="100">
                                        </td>
                                        <td th:text="${'[' +  hdct.chiTietGiay.hang.ten + ']' + ' ' +  hdct.chiTietGiay.giay.ten + ' ' + hdct.chiTietGiay.ten + ' ' + '[' + hdct.chiTietGiay.mauSac.ten + ']'}"></td>
                                        <td th:text="${hdct.chiTietGiay.kichCo.ten}"></td>
                                        <td>
                                        <span th:text="${hdct.soLuong}"
                                              style="margin-left: 10px; margin-right: 10px"></span>
                                        </td>

                                        <td>
                                        <span th:if="${hdct.donGia * hdct.soLuong == ((hdct.donGia * (1- ((hdct.phanTramGiam) / 100.0)) * hdct.soLuongGiam)
                                              + (hdct.donGia * (hdct.soLuong - hdct.soLuongGiam)))}">

                                                 <span th:text="${#numbers.formatCurrency((hdct.donGia * (1- ((hdct.phanTramGiam) / 100.0)) * hdct.soLuongGiam)
                                              + (hdct.donGia * (hdct.soLuong - hdct.soLuongGiam)))}"
                                                       style="font-size: 15px"></span>
                            </span>


                                            <span th:unless="${hdct.donGia * hdct.soLuong == ((hdct.donGia * (1- ((hdct.phanTramGiam) / 100.0)) * hdct.soLuongGiam)
                                              + (hdct.donGia * (hdct.soLuong - hdct.soLuongGiam)))}">
                                <span th:text="${#numbers.formatCurrency(hdct.donGia * hdct.soLuong)}"
                                      style="text-decoration: line-through; color: red; font-size: 13px"></span>
                                                            <br>
                                                <!--                                                            hdct.soLuong * (hdct.donGia - (hdct.donGia * ((hdct.phanTramGiam) / 100.0))) -->
                                             <span th:text="${#numbers.formatCurrency((hdct.donGia * (1- ((hdct.phanTramGiam) / 100.0)) * hdct.soLuongGiam)
                                              + (hdct.donGia * (hdct.soLuong - hdct.soLuongGiam)))}"
                                                   style="font-size: 15px"></span>
                            </span>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Start Coupon Start -->
        <div class="coupon_area">
            <div class="container" style="max-width: 1140px;">
                <div class="row">
                    <div class="col-lg-6 col-md-6">
                        <div class="coupon_code left" data-aos="fade-up" data-aos-delay="200">
                        </div>
                    </div>
                    <div class="col-lg-6 col-md-6">
                        <div class="coupon_code right" data-aos="fade-up" data-aos-delay="400">
                            <h3>Thanh toán</h3>
                            <div class="coupon_inner">
                                <div class="cart_subtotal">
                                    <p>Tổng tiền</p>
                                    <p class="cart_amount"
                                       th:text="${#numbers.formatCurrency(hoaDon.tongTien + hoaDon.khuyenMai)}"></p>
                                </div>
                                <div class="cart_subtotal">
                                    <p>Khuyến mại</p>
                                    <p class="cart_amount"
                                       th:text="${hoaDon.khuyenMai > 0 ? '- ' + #numbers.formatCurrency(hoaDon.khuyenMai) : #numbers.formatCurrency(hoaDon.khuyenMai)}"></p>
                                </div>
                                <div class="cart_subtotal ">
                                    <p>Tiền Ship</p>
                                    <p class="cart_amount" th:text="${#numbers.formatCurrency(hoaDon.phiShip)}"></p>
                                </div>
                                <div class="cart_subtotal">
                                    <p>Thành tiền</p>
                                    <p class="cart_amount" id="totalAmount"
                                       th:text="${#numbers.formatCurrency(hoaDon.tongTien + hoaDon.phiShip)}"></p>
                                </div>
                                <div th:if="${hoaDon.trangThai == 3 || hoaDon.trangThai == 2}" class="checkout_btn">
                                    <div class="row">
                                        <div class="col-4">

                                        </div>
                                        <div class="col-8">
                                            <button style="background-color: #e66666"  th:href="@{/my-account/cancel/{idhd}(idhd=${hoaDon.id})}" onclick="return confirm('Xác nhận hủy đơn?');"
                                               class="btn btn-md btn-golden" id="CancelBill">Hủy đơn</button>
                                            <button th:if="${hoaDon.trangThai == 2}" type="button" class="btn btn-md btn-golden ml-2" data-bs-toggle="modal" data-bs-target="#modalChonPhuongThuc">
                                                Thanh toán Ngay
                                            </button>
                                        </div>
                                    </div>

                                </div>



                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div> <!-- End Coupon Start -->
    </div>


    <!-- material-scrolltop button -->
    <button class="material-scrolltop" type="button"></button>


</div>

<div class="modal fade" id="modalChonPhuongThuc" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog  modal-dialog-centered" role="document" style="width: 500px">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Chọn hình thức thanh toán</h5>
                <div class="col text-right">
                    <button type="button" class="close modal-close" data-bs-dismiss="modal"
                            aria-label="Close">
                        <span aria-hidden="true"> <i class="fa fa-times"></i></span>
                    </button>
                </div>
            </div>
            <form th:action="@{/my-account/thanh-toan}" method="get" id="formHinhThuc">
                <div class="modal-body">
                    <div class="container">
                        <div class="row">
                            <label class="checkbox-default" for="currencyPaypal">
                                <input checked type="radio" id="currencyPaypal" name="hinhThucThanhToan" value="2">
                                <span>Thanh toán VNPay</span>
                            </label>
                        </div>

                        <div class="row mt-3">
                            <label class="checkbox-default" for="currencyCod">
                                <input type="radio" id="currencyCod" name="hinhThucThanhToan" value="3">
                                <span>Thanh toán khi nhận hàng</span>
                            </label>
                        </div>

                        <div class="row mt-7">
                            <div class="col-12">
                                <h6>Ghi chú (nếu cần):</h6>
                                <textarea style="width: 450px" rows="5" name="ghiChu"
                                          placeholder="Nhập ghi chú cho đơn hàng..."></textarea>
                            </div>
                        </div>

                        <div class="row mt-2">
                            <div class="col-12">
                                <button class="btn btn-md btn-golden" style="float: right" type="submit"
                                        id="btnXacNhan" onclick="return submitForm()" >Xác nhận
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>


<script src="/assets/js/vendor/vendor.min.js"></script>
<script src="/assets/js/plugins/plugins.min.js"></script>

<!-- Main JS -->
<script src="/assets/js/main.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<script th:inline="javascript">
    const one = document.querySelector(".one");
    const two = document.querySelector(".two");
    const three = document.querySelector(".three");
    const four = document.querySelector(".four");
    const five = document.querySelector(".five");
    const listLSHD = [[${lichSuHoaDon}]];
    let value = null;
    let date = null;


    window.addEventListener('DOMContentLoaded', function () {
        value = check('2');
        if (value != null) {
            fillTimeLine('icon1', 'text1', value, 'Chờ thanh toán', 'uil-comment-alt-question');
        }
        value = check('3');
        if (value != null) {
            fillTimeLine('icon1', 'text1', value, 'Chờ Xác nhận', 'uil-comment-alt-question');
        }
        value = check('6');
        if (value != null) {
            fillTimeLine('icon2', 'text2', value, 'Hủy', 'uil-trash-alt');
        }
        value = check('4');
        if (value != null && value.hoaDon.loaiHoaDon != 1) {
            fillTimeLine('icon2', 'text2', value, 'Chờ giao', 'uil-clock-nine');
        }
        value = check('6');
        if (value != null && listLSHD.length == 3) {
            fillTimeLine('icon3', 'text3', value, 'Hủy', 'uil-trash-alt');
        }
        value = check('5');
        if (value != null && value.hoaDon.loaiHoaDon != 1) {
            fillTimeLine('icon3', 'text3', value, 'Đang giao', 'uil-ambulance');
        }
        value = check('7');
        if (value != null && value.hoaDon.loaiHoaDon != 1) {
            fillTimeLine('icon4', 'text4', value, 'Giao thất bại', 'uil-truck');
            return;
        }
        value = check('1');
        if (value != null) {
            if (value.hoaDon.loaiHoaDon == 1) {
                fillTimeLine('icon2', 'text2', value, 'Thành công', 'uil-check-circle');
            } else
                fillTimeLine('icon4', 'text4', value, 'Thành công', 'uil-check-circle');
        }

    })

    function fillTimeLine(icon, text, value, trangThai, classIcon) {
        date = moment(value.createdDate).utcOffset(7).format('DD-MM-YYYY HH:mm:ss');
        activeTab(value);
        document.getElementById(icon).style.color = '#b19361';
        document.getElementById(icon).classList.remove('uil-circle');
        document.getElementById(icon).classList.add(classIcon);
        document.getElementById(text).innerHTML =
            `<span style="font-weight: 550;">${trangThai}</span> <br>
                        <span style="font-size: 12px;  text-align: center;">${date}</span> <br>`;
    }


    function activeTab(value) {
        if (listLSHD.length == 1) {
            one.classList.add("active");
            two.classList.remove("active");
            three.classList.remove("active");
            four.classList.remove("active");
            five.classList.remove("active");
            return;
        }
        if (listLSHD.length == 2) {
            one.classList.add("active");
            two.classList.add("active");
            three.classList.remove("active");
            four.classList.remove("active");
            five.classList.remove("active");
            return;
        }
        if (listLSHD.length == 3) {
            one.classList.add("active");
            two.classList.add("active");
            three.classList.add("active");
            four.classList.remove("active");
            five.classList.remove("active");
            return;
        }

        if (listLSHD.length == 4) {
            one.classList.add("active");
            two.classList.add("active");
            three.classList.add("active");
            four.classList.add("active");
            five.classList.remove("active");
            return;
        }

        if (listLSHD.length == 5) {
            one.classList.add("active");
            two.classList.add("active");
            three.classList.add("active");
            four.classList.add("active");
            five.classList.add("active");
            return;
        }

    }

    const bild = document.getElementById("CancelBill");
    bild.addEventListener('click', function (event) {
        event.preventDefault();
        let value = prompt("Nhập lí do hủy: ");
        if (value == null) {
            return;
        }
        if (value.trim().length == 0) {
            alert("Bạn chưa nhập lý do")
            return;
        }
        if (value.length > 150) {
            alert("Nhập tối đa 150 kí tự")
            return;
        }

        let href = bild.getAttribute('href') + '?value=' + value;
        window.location.href = href;
    })

    function check(phuongThuc) {
        for (let i = 0; i < listLSHD.length; i++) {
            if (listLSHD[i].phuongThuc == phuongThuc) {
                return listLSHD[i];
            }
        }
        return null;
    }

    function submitForm() {
        var selectedPaymentMethod = document.querySelector('input[name="hinhThucThanhToan"]:checked').value;
        const formThanhToan = document.getElementById("formHinhThuc");
        const hoaDonId = [[${session.idHoaDon}]];

        fetch("/giohangchitiet/validate/" + hoaDonId)
            .then(response => response.text())
            .then(result => {
                if (result === "Số lượng sản phẩm đủ, có thể thanh toán.") {
                    if (selectedPaymentMethod === "2") {
                        formThanhToan.submit();
                        fetch("/api/payment/create_payment?totalAmount=" + encodeURIComponent(document.getElementById("totalAmount").innerText))
                            .then(response => response.text())
                            .then(paymentUrl => {
                                console.log("Received Payment URL:", paymentUrl);
                                window.location.href = paymentUrl;
                            }).catch(error => {
                            console.error("Error fetching payment URL:", error);
                        });
                    }
                } else {
                    let type = 'error';
                    let icon = 'fa-solid fa-circle-exclamation';
                    let title = 'Thất bại!';
                    let text = result;
                    createToast(type, icon, title, text);
                }
            }).catch(error => {
            console.error("Error validating product quantities:", error);
        });

        return false;
    }


    function handlePaymentButtonClick() {

        console.log("Button clicked");
        var selectedRadioButton = document.querySelector('input[name="hinhThucThanhToan"]:checked');

        if (selectedRadioButton === null) {
            console.log("No radio button selected");
            let type = 'error';
            let icon = 'fa-solid fa-circle-exclamation';
            let title = 'Chưa chọn hình thức!';
            let text = "Bạn chưa chọn hình thức thanh toán!";
            createToast(type, icon, title, text);
        }
    }
</script>
</body>


</html>